(function(n){typeof define=="function"&&define.amd?define(["jquery"],n):typeof exports=="object"?n(require("jquery")):n(jQuery)})(function(n){"use strict";function i(n){this.$container=n;this.$avatarView=this.$container.find(".avatar-viewer");this.$avatar=this.$avatarView.find("img");this.$avatarModal=this.$container.find("#avatar-modal");this.$loading=this.$container.find(".loading");this.$avatarForm=this.$avatarModal.find(".avatar-form");this.$avatarUpload=this.$avatarForm.find(".avatar-upload");this.$avatarSrc=this.$avatarForm.find(".avatar-src");this.$avatarData=this.$avatarForm.find(".avatar-data");this.$avatarInput=this.$avatarForm.find(".avatar-input");this.$avatarSave=this.$avatarForm.find(".avatar-save");this.$avatarBtns=this.$avatarForm.find(".avatar-btns");this.$avatarWrapper=this.$avatarModal.find(".avatar-wrapper");this.$avatarPreview=this.$avatarModal.find(".avatar-preview");this.init()}var t=window.console||{log:function(){}};i.prototype={constructor:i,support:{fileList:!!n('<input type="file">').prop("files"),blobURLs:!!window.URL&&URL.createObjectURL,formData:!!window.FormData},init:function(){this.support.datauri=this.support.fileList&&this.support.blobURLs;this.support.formData||this.initIframe();this.initTooltip();this.initModal();this.addListener()},addListener:function(){this.$avatarView.on("click",n.proxy(this.click,this));this.$avatarInput.on("change",n.proxy(this.change,this));this.$avatarForm.on("submit",n.proxy(this.submit,this));this.$avatarBtns.on("click",n.proxy(this.rotate,this))},initTooltip:function(){this.$avatarView.tooltip({placement:"bottom"})},initModal:function(){this.$avatarModal.modal({show:!1})},initPreview:function(){var n=this.$avatar.attr("src");this.$avatarPreview.html('<img src="'+n+'">')},initIframe:function(){var u="upload-iframe-"+(new Date).getTime(),i=n("<iframe>").attr({name:u,src:""}),r=this;i.one("load",function(){i.on("load",function(){var i;try{i=n(this).contents().find("body").text()}catch(u){t.log(u.message)}if(i){try{i=n.parseJSON(i)}catch(u){t.log(u.message)}r.submitDone(i)}else r.submitFail("Image upload failed!");r.submitEnd()})});this.$iframe=i;this.$avatarForm.attr("target",u).after(i.hide())},click:function(){this.$avatarModal.modal("show");this.initPreview()},change:function(){var t,n;this.support.datauri?(t=this.$avatarInput.prop("files"),t.length>0&&(n=t[0],this.isImageFile(n)&&(this.url&&URL.revokeObjectURL(this.url),this.url=URL.createObjectURL(n),this.startCropper()))):(n=this.$avatarInput.val(),this.isImageFile(n)&&this.syncUpload())},submit:function(){return!this.$avatarSrc.val()&&!this.$avatarInput.val()?!1:this.support.formData?(this.ajaxUpload(),!1):void 0},rotate:function(t){var i;this.active&&(i=n(t.target).data(),i.method&&this.$img.cropper(i.method,i.option))},isImageFile:function(n){return n.type?/^image\/\w+$/.test(n.type):/\.(jpg|jpeg|png|gif)$/.test(n)},startCropper:function(){var t=this;this.active?this.$img.cropper("replace",this.url):(this.$img=n('<img src="'+this.url+'">'),this.$avatarWrapper.empty().html(this.$img),this.$img.cropper({aspectRatio:1,preview:this.$avatarPreview.selector,crop:function(n){var i=['{"x":'+n.x,'"y":'+n.y,'"height":'+n.height,'"width":'+n.width,'"rotate":'+n.rotate+"}"].join();t.$avatarData.val(i)},cropBoxResizable:!1}),this.active=!0);this.$avatarModal.one("hidden.bs.modal",function(){t.$avatarPreview.empty();t.stopCropper()})},stopCropper:function(){this.active&&(this.$img.cropper("destroy"),this.$img.remove(),this.active=!1)},ajaxUpload:function(){var r=this.$avatarForm.attr("action"),u=new FormData(this.$avatarForm[0]),i=this;n.ajax(r,{type:"post",data:u,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){i.submitStart()},success:function(n){t.log(n);i.submitDone(n)},error:function(n,t,r){i.submitFail(t||r)},complete:function(){i.submitEnd()}})},syncUpload:function(){this.$avatarSave.click()},submitStart:function(){this.$loading.fadeIn()},submitDone:function(t){n.isPlainObject(t)&&t.state===200?t.result?(n("#jdforms-images").val(t.src),this.url=jdmath.root()+t.src,n("#img-avatar").attr("src",this.url),this.support.datauri||this.uploaded?(this.uploaded=!1,this.cropDone()):(this.uploaded=!0,this.startCropper()),this.$avatarInput.val("")):t.message&&this.alert(t.message):this.alert("Failed to response")},submitFail:function(n){this.alert(n)},submitEnd:function(){this.$loading.fadeOut()},cropDone:function(){this.$avatarForm.get(0).reset();this.$avatar.attr("src",this.url);this.stopCropper();this.$avatarModal.modal("hide")},alert:function(n){var t=['<div class="alert alert-danger avatar-alert alert-dismissable">','<button type="button" class="close" data-dismiss="alert">&times;<\/button>',n,"<\/div>"].join("");this.$avatarUpload.after(t)}};n(function(){return new i(n("#crop-avatar"))})});